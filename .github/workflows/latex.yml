name: Build LaTeX PDFs

on:
  push:
    paths:
      - "**/*.tex"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Step 1 — detect modified .tex files in the last commit
      - name: Find modified tex files
        id: tex
        run: |
          # If no parent commit exists, skip
          if ! git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi

          FILES=$(git diff --name-only HEAD^ HEAD -- "*.tex" || true)

          # Write GitHub multiline output safely
          {
            echo "files<<EOF"
            for f in $FILES; do
              echo "$f"
            done
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # Step 2 — build PDFs only for changed .tex files
      - name: Build PDFs
        if: steps.tex.outputs.files != ''
        uses: xu-cheng/latex-action@v4
        with:
          root_file: ${{ steps.tex.outputs.files }}

      # Step 3 — commit generated PDFs back to the repo
      # FIX: properly iterate over multiline output
      - name: Commit PDFs
        if: steps.tex.outputs.files != ''
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # IMPORTANT: read multiline output correctly
          while IFS= read -r f; do
            pdf="${f%.tex}.pdf"
            echo "Checking for $pdf"
            if [ -f "$pdf" ]; then
              echo "Adding $pdf"
              git add "$pdf"
            else
              echo "PDF not found: $pdf"
            fi
          done <<< "${{ steps.tex.outputs.files }}"

          if git diff --cached --quiet; then
            echo "No PDFs to commit"
            exit 0
          fi

          git commit -m "Auto-build PDFs"
          git push
