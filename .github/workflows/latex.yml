name: Build LaTeX PDFs

on:
  push:
    paths:
      - "**/*.tex"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Step 1: detect modified tex files
      - name: Find modified tex files
        id: tex
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | grep ".tex$" || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      # Step 2: compile each tex file
      - name: Build PDFs
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ steps.tex.outputs.files }}

      # Step 3: commit back the PDFs
      - name: Commit PDFs
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          for f in ${{ steps.tex.outputs.files }}; do
            base="${f%.tex}"
            pdf="${base}.pdf"
            if [ -f "$pdf" ]; then
              git add "$pdf"
            fi
          done

          if git diff --cached --quiet; then
            echo "Nothing to commit"
            exit 0
          fi

          git commit -m "Auto-build PDFs"
          git push
