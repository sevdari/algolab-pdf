name: Build LaTeX PDFs

on:
  push:
    paths:
      - "**/*.tex"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout with depth 2 so HEAD^ exists
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Step 1 — detect modified .tex files in *last commit*
      - name: Find modified tex files
        id: tex
        run: |
          # If the repo only has one commit, skip
          if ! git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi

          FILES=$(git diff --name-only HEAD^ HEAD -- "*.tex" || true)

          # Write multiline output correctly
          {
            echo "files<<EOF"
            for f in $FILES; do
              echo "$f"
            done
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # Step 2 — build PDFs only if files changed
      - name: Build PDFs
        if: steps.tex.outputs.files != ''
        uses: xu-cheng/latex-action@v4
        with:
          root_file: ${{ steps.tex.outputs.files }}

      # Step 3 — commit built PDFs back to the repo
      - name: Commit PDFs
        if: steps.tex.outputs.files != ''
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          for f in ${{ steps.tex.outputs.files }}; do
            pdf="${f%.tex}.pdf"
            if [ -f "$pdf" ]; then
              git add "$pdf"
            fi
          done

          if git diff --cached --quiet; then
            echo "No PDFs to commit"
            exit 0
          fi

          git commit -m "Auto-build PDFs"
          git push
